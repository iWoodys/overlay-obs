<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Overlay OBS · Control Mods</title>
  <style>
    :root {
      --bg: transparent;
      --card-bg-dark: #000; /* sólido */
      --card-bg-light: #fff; /* sólido */
      --border-dark: rgba(255,255,255,.12);
      --border-light: rgba(0,0,0,.10);
      --text: #fff;
      --text-dark: #111;
      --shadow: 0 8px 40px rgba(0,0,0,.35);
      --radius: 16px;
      --blur: 10px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; background: var(--bg); font-family: var(--font); }
    .full { min-height: 100%; display: grid; place-items: center; padding: 24px; }

    /* Overlay card */
    .card {
      display:inline-flex; align-items:center; gap:12px; padding:12px 16px;
      border-radius: var(--radius); border:1px solid var(--border-dark);
      box-shadow: var(--shadow);
      background: var(--card-bg-dark); /* oscuro por defecto */
      color: var(--text);
    }
    .chip { opacity:.7 }
    .txt-xl{ font-size: clamp(18px, 2.2vw, 28px); font-weight: 700; letter-spacing: -0.2px; }
    .txt-lg{ font-size: clamp(16px, 2vw, 24px); font-weight: 600; }

    /* Control layout */
    .wrap { max-width: 880px; margin: 0 auto; padding: 24px; color:#fff; }
    .panel { background: rgba(17,17,17,.7); border:1px solid rgba(255,255,255,.12); border-radius: 16px; padding: 16px; backdrop-filter: blur(8px); }
    .row { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    .row-2 { display:grid; grid-template-columns: repeat(2, 1fr); gap:12px; }
    .row-5 { display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; }
    label { font-size:12px; opacity:.8 }
    input, select, button { width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.06); color:#fff; outline:none; }
    button { cursor:pointer; }
    .muted{ opacity:.75 }
    .space{ height: 12px; }
    .flex{ display:flex; gap:8px; align-items:center; }
    .right{ justify-content: flex-end; }
    .preview { padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); }

    /* Align containers */
    .align-left  { justify-content: flex-start; }
    .align-center{ justify-content: center; }
    .align-right { justify-content: flex-end; }

    /* Light theme override */
    .light {
      color: var(--text-dark);
      border-color: var(--border-light) !important;
      background: var(--card-bg-light) !important;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- Firebase v9 CDN (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

    // === Config de Firebase (UNA sola declaración)
    const firebaseConfig = {
      apiKey: "AIzaSyB_ftb81GpcvFUVuydA8Crz5aaOwC3SAYo",
      authDomain: "overlay-4a8e5.firebaseapp.com",
      databaseURL: "https://overlay-4a8e5-default-rtdb.firebaseio.com",
      projectId: "overlay-4a8e5",
      storageBucket: "overlay-4a8e5.firebasestorage.app",
      messagingSenderId: "620671976127",
      appId: "1:620671976127:web:757d18aee43f5a39007c0a"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // Estado por defecto
    const defaultState = {
      bo: "BO3",         // BO1 | BO3 | BO5
      matchType: "1v1",  // 1v1 | 2v2
      result: "0-0",
      teamUser: "",      // tu usuario/equipo (solo 2v2)
      opponent: "user",  // rival o equipo rival
      amount: "$0",
      visible: true,
      theme: "dark",     // dark | light
      align: "left",     // left | center | right
    };

    // Parámetros
    const qs = new URLSearchParams(location.search);
    const view = qs.get('view') || 'overlay'; // overlay | control
    const room = qs.get('room') || 'default';
    const key  = qs.get('key'); // llavecita simple para control

    const $ = (sel) => document.querySelector(sel);
    const appRoot = document.getElementById('app');
    const roomPath = (r) => `rooms/${r}`;

    // ========== RENDER OVERLAY ==========
    function renderOverlay(state){
      const isLight = state.theme === 'light';
      const alignCls = state.align === 'center' ? 'align-center' : (state.align === 'right' ? 'align-right' : 'align-left');
      const is2v2 = state.matchType === '2v2';
      const teamPart = is2v2 ? `<span class="txt-lg">${escapeHtml(state.teamUser||'')}</span><span class="chip">|</span>` : '';

      appRoot.innerHTML = `
        <div class="full ${alignCls}">
          ${state.visible ? `
          <div class="card ${isLight ? 'light' : ''}">
            <span class="txt-lg">${escapeHtml(state.bo)}</span>
            <span class="chip">|</span>
            <span class="txt-lg">${escapeHtml(state.matchType)}</span>
            <span class="chip">|</span>
            <span class="txt-lg">${escapeHtml(state.result)}</span>
            <span class="chip">|</span>
            ${teamPart}
            <span class="txt-lg">vs ${escapeHtml(state.opponent)}</span>
            <span class="chip">|</span>
            <span class="txt-xl">${escapeHtml(state.amount)}</span>
          </div>` : ``}
        </div>
      `;
    }

    // ========== RENDER CONTROL ==========
    function renderControl(state){
      if(!key){
        appRoot.innerHTML = `
          <div class="full">
            <div class="wrap">
              <div class="panel">
                <h2>Acceso de moderadores</h2>
                <p class="muted">Agrega <code>&key=TU_CLAVE</code> a la URL para entrar.
                Ejemplo: <code>?view=control&room=miCanal&key=1234</code></p>
              </div>
            </div>
          </div>`;
        return;
      }

      const is2v2 = state.matchType === '2v2';

      appRoot.innerHTML = `
        <div class="wrap">
          <h1 class="muted">Overlay Controller · Room: <code>${escapeHtml(room)}</code></h1>
          <div class="space"></div>

          <div class="panel">
            <div class="row-5">
              <div>
                <label>BO</label>
                <select id="f-bo">
                  <option value="BO1" ${state.bo==='BO1'?'selected':''}>BO1</option>
                  <option value="BO3" ${state.bo==='BO3'?'selected':''}>BO3</option>
                  <option value="BO5" ${state.bo==='BO5'?'selected':''}>BO5</option>
                </select>
              </div>
              <div>
                <label>Tipo de match</label>
                <select id="f-type">
                  <option value="1v1" ${state.matchType==='1v1'?'selected':''}>1v1</option>
                  <option value="2v2" ${state.matchType==='2v2'?'selected':''}>2v2</option>
                </select>
              </div>
              <div>
                <label>Resultado</label>
                <input id="f-res" placeholder="1-1" value="${escapeAttr(state.result)}" />
              </div>
              <div>
                <label>Usuario equipo</label>
                <input id="f-team" placeholder="tu equipo" value="${escapeAttr(state.teamUser||'')}" style="display:${is2v2?'block':'none'}" />
              </div>
              <div>
                <label>Usuario rival / equipo rival</label>
                <input id="f-op" placeholder="@rival o equipo" value="${escapeAttr(state.opponent)}" />
              </div>
              <div>
                <label>Monto</label>
                <input id="f-amt" placeholder="$0" value="${escapeAttr(state.amount)}" />
              </div>
            </div>

            <div class="space"></div>

            <div class="row">
              <div>
                <label>Tema</label>
                <select id="f-theme">
                  <option value="dark" ${state.theme==='dark'?'selected':''}>Oscuro</option>
                  <option value="light" ${state.theme==='light'?'selected':''}>Claro</option>
                </select>
              </div>
              <div>
                <label>Alineación</label>
                <select id="f-align">
                  <option value="left" ${state.align==='left'?'selected':''}>Izquierda</option>
                  <option value="center" ${state.align==='center'?'selected':''}>Centro</option>
                  <option value="right" ${state.align==='right'?'selected':''}>Derecha</option>
                </select>
              </div>
              <div class="flex right">
                <button id="btn-save">Guardar</button>
              </div>
            </div>

            <div class="space"></div>

            <div class="row-2">
              <button id="btn-toggle">${state.visible ? 'Ocultar' : 'Mostrar'}</button>
              <button id="btn-reset">Reset</button>
            </div>
          </div>

          <div class="space"></div>

          <div class="panel">
            <div class="muted">Preview</div>
            <div class="space"></div>
            <div class="preview" id="preview"></div>
          </div>

          <div class="space"></div>

          <div class="panel">
            <div class="row-2">
              <button id="btn-copy-overlay">Copiar URL Overlay</button>
              <button id="btn-copy-control">Copiar URL Control</button>
            </div>
          </div>
        </div>
      `;

      const $bo    = document.getElementById('f-bo');
      const $type  = document.getElementById('f-type');
      const $res   = document.getElementById('f-res');
      const $team  = document.getElementById('f-team');
      const $op    = document.getElementById('f-op');
      const $amt   = document.getElementById('f-amt');
      const $theme = document.getElementById('f-theme');
      const $align = document.getElementById('f-align');
      const $save  = document.getElementById('btn-save');
      const $toggle= document.getElementById('btn-toggle');
      const $reset = document.getElementById('btn-reset');
      const $prev  = document.getElementById('preview');
      const $copyOv= document.getElementById('btn-copy-overlay');
      const $copyCt= document.getElementById('btn-copy-control');

      const renderPrev = () => {
        const is2v2p = ($type.value === '2v2');
        if ($team) $team.style.display = is2v2p ? 'block' : 'none';

        const teamPart = is2v2p
          ? `${escapeHtml($team.value)} <span class="chip">|</span>`
          : '';

        $prev.innerHTML = `
          <div class="card ${($theme.value==='light')?'light':''}">
            <span class="txt-lg">${escapeHtml($bo.value)}</span>
            <span class="chip">|</span>
            <span class="txt-lg">${escapeHtml($type.value)}</span>
            <span class="chip">|</span>
            <span class="txt-lg">${escapeHtml($res.value)}</span>
            <span class="chip">|</span>
            ${teamPart}
            <span class="txt-lg">vs ${escapeHtml($op.value)}</span>
            <span class="chip">|</span>
            <span class="txt-xl">${escapeHtml($amt.value)}</span>
          </div>`;
      };
      renderPrev();

      [$bo,$type,$res,$team,$op,$amt].forEach(el=>el.addEventListener('input', renderPrev));
      $theme.addEventListener('change', renderPrev);

      $save.addEventListener('click', async () => {
        await update(ref(db, roomPath(room)), {
          bo: $bo.value,
          matchType: $type.value,
          result: $res.value,
          teamUser: $team.value,
          opponent: $op.value,
          amount: $amt.value,
          theme: $theme.value,
          align: $align.value,
        });
        alert('Guardado');
      });

      $toggle.addEventListener('click', async () => {
        await update(ref(db, roomPath(room)), { visible: !state.visible });
      });

      $reset.addEventListener('click', async () => {
        await set(ref(db, roomPath(room)), defaultState);
      });

      const makeUrl = (v) => {
        const base = location.origin + location.pathname;
        const q = new URLSearchParams({ view: v, room });
        if(v==='control' && key) q.set('key', key);
        return `${base}?${q.toString()}`;
      };

      $copyOv.addEventListener('click', async () => {
        await navigator.clipboard.writeText(makeUrl('overlay'));
        alert('URL de Overlay copiada');
      });
      $copyCt.addEventListener('click', async () => {
        await navigator.clipboard.writeText(makeUrl('control'));
        alert('URL de Control copiada');
      });
    }

    // Escapes
    const escapeHtml = (s = '') => {
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
      return String(s).replace(/[&<>"']/g, (m) => map[m]);
    };
    const escapeAttr = escapeHtml;

    // Live binding
    const r = ref(db, roomPath(room));
    onValue(r, async (snap) => {
      let data = snap.val();
      if (!data) {
        await set(ref(db, roomPath(room)), defaultState);
        data = defaultState;
      }
      const merged = Object.assign({}, defaultState, data || {});
      if (view === 'overlay') {
        document.body.style.color = merged.theme === 'light' ? 'var(--text-dark)' : 'var(--text)';
        renderOverlay(merged);
      } else {
        renderControl(merged);
      }
    });
  </script>
</body>
</html>
